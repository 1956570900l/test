# 1_arch_diagram.md：系统架构与分工说明（适配Weaviate）
## 一、架构核心目标
1. 支撑初赛：实现“文档上传→Weaviate知识库构建→问题检索→生成results.jsonl”全链路，严格符合比赛格式（含规范名、页码、条款号、原文）。
2. 预留决赛：兼容Weaviate大规模扩展（支持100+规范文档），预留图文联合检索、Docker部署接口，无需重构核心代码。
3. 3人协作友好：架构+前端+后端分工无重叠，每个模块对应唯一负责人，降低沟通成本，确保快速迭代。

## 二、完整架构图（文字版+数据流向+技术栈）
### 1. 整体链路（从输入到输出全流程）
用户 / 评委 → 前端页面（队友 C）→ 后端 API 接口（队友 B）→ 核心业务模块（队友 A + 队友 B）→ 输出结果（results.jsonl/ 可视化答案）

### 2. 模块拆解与详细说明（按流程排序）
| 流程步骤 | 核心模块         | 负责人   | 核心功能                                  | 技术栈                          | 输入数据                          | 输出数据                          | 依赖模块/工具                          |
|----------|------------------|----------|-------------------------------------------|---------------------------------|-----------------------------------|-----------------------------------|---------------------------------------|
| 1        | 前端上传模块     | 队友C    | 接收比赛规范文档（PDF/Word/PPT），格式校验（仅允许指定后缀） | HTML+CSS+原生JS+Jinja2          | 用户本地文档（多文件）            | 文档文件流 → 后端数据处理模块     | 后端/api/upload_docs接口              |
| 2        | 数据处理模块     | 队友A    | 解析文档文本+提取元数据（doc_name/page/clause_id），文本分片 | LangChain（PyPDFLoader/python-docx）+ 正则 | 前端传来的文档文件流              | LangChain Document列表（含完整元数据） | 无（独立模块，输出给知识库模块）       |
| 3        | Weaviate知识库模块 | 队友A    | 文档向量转换、存入Weaviate Class，提供检索接口 | Weaviate+langchain-weaviate+sentence-transformers | 数据处理模块输出的Document列表    | 向量数据（关联元数据）存入Weaviate；检索结果列表 | Weaviate服务（需提前部署）            |
| 4        | 前端问答模块     | 队友C    | 接收用户工程风险问题，展示Top-3匹配结果（含条款号/页码） | HTML+CSS+原生JS                 | 用户输入的问题文本                | 问题文本 → 后端RAG检索模块        | 后端/api/query_single接口              |
| 5        | RAG检索模块      | 队友B    | 调用Weaviate检索Top-3条款，结合LLM生成规范答案 | LangChain RetrievalQA + OpenAI/开源LLM（Phi-2） | 前端传来的问题文本                | 带元数据的Top-3匹配结果（含相似度）    | Weaviate知识库模块                    |
| 6        | 结果生成模块     | 队友B    | 记录所有历史查询结果，按比赛格式生成results.jsonl文件 | Python jsonlines库+字典格式化    | RAG检索模块输出的Top-3结果        | 符合比赛要求的results.jsonl文件       | RAG检索模块                          |
| 7        | 前端导出模块     | 队友C    | 提供results.jsonl下载入口，展示历史查询记录 | HTML+CSS+原生JS                 | 后端返回的jsonlines文件流         | 下载文件到用户本地（用于比赛提交）     | 后端/api/export_results接口            |

### 3. 核心模块依赖关系图（括号+逗号格式，按数据流向排序）
#### 依赖说明：
- 箭头`→`表示“数据流向/依赖”，即前一个模块的输出是后一个模块的输入；
- 逗号分隔并行依赖，即`(前端问答模块)`与`(Weaviate知识库模块)`均为`(RAG检索模块)`的输入依赖（前者提供问题文本，后者提供检索结果）。

## 三、3人团队分工表（无重叠，责任明确）
| 角色   | 负责模块         | 具体工作清单（可直接落地）                          | 交付物（可验证）                          | 完成标准（小白可判断）                          |
|--------|------------------|---------------------------------------|-------------------------------------------|-------------------------------------------|
| 架构师 | 全局设计与协调   | 1. 编写/维护arch文件夹下所有文档（1_~3_）；2. 提供后端核心脚手架代码（Weaviate连接/LLM初始化）；3. 联调时解决跨模块问题（如接口格式不匹配、Weaviate连接失败）；4. 验证最终结果符合比赛格式 | 1. arch/下3个完整文档；2. backend_base.py脚手架；3. 联调测试清单；4. 合格的results.jsonl样例 | 1. 所有文档无歧义，队友可直接按文档开发；2. 脚手架代码可直接运行；3. 全流程联调无报错 |
| 前端（队友C） | 前端3大模块      | 1. 开发upload.html（文档上传+格式校验+跳转）；2. 开发query.html（问题输入+结果可视化展示）；3. 开发export.html（结果下载+历史记录）；4. 确保页面适配浏览器，操作流程清晰 | 1. 3个可访问的HTML页面（localhost:8000可打开）；2. 页面间跳转正常；3. 接口调用无跨域错误 | 1. 上传非指定格式文件能提示错误；2. 输入问题能显示带条款号的结果；3. 点击下载能获取results.jsonl |
| 后端（队友A） | 数据处理+Weaviate知识库 | 1. 开发pdf_processor.py（PDF解析+元数据提取）；2. 开发weaviate_client.py（Weaviate连接/数据写入/检索）；3. 确保Document元数据完整（含doc_name/page/clause_id）；4. 测试Weaviate数据入库与检索功能 | 1. 上传PDF后能输出含完整元数据的Document列表；2. Weaviate的EngineeringSpecs Class有数据；3. 调用检索函数能返回Top-3结果 | 1. Document列表无缺失字段；2. Weaviate控制台能看到入库数据；3. 检索结果相似度排序正确 |
| 后端（队友B） | RAG检索+API+结果生成 | 1. 开发rag_chain.py（LangChain RetrievalQA构建）；2. 开发main.py（FastAPI接口实现：/upload_docs:/query_single:/export_results）；3. 开发result_generator.py（生成results.jsonl）；4. 处理接口异常（如知识库为空、参数为空） | 1. 输入问题能返回带元数据的Top-3结果；2. 3个API接口可正常调用；3. 导出的results.jsonl符合比赛格式 | 1. 接口返回状态码正确（成功200，失败400）；2. results.jsonl每行格式符合比赛要求；3. 异常情况能返回明确提示 |

## 四、阶段重点与扩展规划（初赛必做vs决赛加分）
| 阶段   | 模块重点（初赛必须完成）                          | 决赛扩展方向（加分项）                          | 扩展所需技术/工具                          |
|--------|-----------------------------------|-------------------------------------------|---------------------------------------|
| 数据处理 | 仅处理PDF，手动标注clause_id（确保格式正确，如“3.2.1”） | 支持Word/PPT解析；自动识别clause_id（正则+LLM）；图片OCR提取 | python-docx/python-pptx；pytesseract；开源LLM |
| Weaviate知识库 | 单Class存储（EngineeringSpecs）；基础向量索引 | 多Class存储（按规范类型分类）；索引优化（HNSW）；数据分片 | Weaviate多Class配置；索引参数调整 |
| RAG检索  | 文本语义检索，返回Top-3文本结果；基础prompt工程 | 图文联合检索（图片向量+文本向量）；结果重排序；置信度评分 | CLIP模型；交叉注意力机制；相似度加权算法 |
| 前端     | 基础功能实现，无样式要求；核心流程完整 | 工程主题美化；图片预览组件；条款高亮；响应式布局 | Bootstrap；图片预览JS插件 |
| 工程部署 | 本地运行，无部署要求 | Docker封装（一键启动前端+后端+Weaviate）；Linux服务器部署 | Docker；docker-compose；Nginx |

## 五、关键约束与注意事项（避免开发跑偏）
1. 元数据约束：所有模块必须携带`doc_name`（规范文件名，带后缀）、`page`（页码，1开始）、`clause_id`（条款号，格式如“x.x.x”），缺失将直接影响比赛评分（语义匹配分+Top-1 Accuracy）。
2. Weaviate约束：Class名固定为“EngineeringSpecs”，向量维度固定为768（匹配all-MiniLM-L6-v2模型），避免后续检索异常。
3. 接口约束：前后端接口格式必须严格遵循`2_interface_spec.md`，后端接口必须返回`status`（success/fail）和`message`字段，方便前端调试。
4. 兼容性约束：所有技术栈选择开源免费工具，避免商业授权问题（如Docker个人版、Weaviate社区版、LangChain开源版）。